import"../chunks/DsnmJJEf.js";import"../chunks/BcPgcvTn.js";import{o as Ht,p as zt,d as ea,c as l,s as o,r,t as I,i as e,z as S,a as Lt,a0 as pt,a1 as Q,f as sa}from"../chunks/BpRt2mh-.js";import{a as F,f as H}from"../chunks/CXy7eh0M.js";import{r as ia,a as x,e as $,i as ra}from"../chunks/6gtY402H.js";import{t as ca,s as J}from"../chunks/CK5yDnZ6.js";import{i as na}from"../chunks/DiEZq4G_.js";import{s as la,a as oa}from"../chunks/Ctf5viQA.js";import{o as ha}from"../chunks/BvwCr5sS.js";import{d as da,s as w,e as ua,r as pa,a as D}from"../chunks/CSeQF5Ga.js";import{i as Rt}from"../chunks/D5Mqzety.js";import{b as va}from"../chunks/D3iX995e.js";import{b as Pt}from"../chunks/CZx5pxKY.js";import{S as O,c as ma}from"../chunks/Nz_3zEkQ.js";import{i as Bt,K as E,c as p,s as _,g as C,m as A,n as ba,p as fa,P as B,r as j,b as z,d as _a,e as X,f as ga,h as ya,a as Y}from"../chunks/CGV0KQgZ.js";function Sa(b,t,u,d){var h=b.__style;if(Ht||h!==t){var s=ca(t);(!Ht||s!==b.getAttribute("style"))&&(s==null?b.removeAttribute("style"):b.style.cssText=s),b.__style=t}return d}const m=E*10;class xa{constructor(t={}){const u=!Bt(t.bounce)||!Bt(t.duration);this.timeStep=.02,this.restThreshold=5e-4,this.restDuration=200,this.maxDuration=6e4,this.maxRestSteps=this.restDuration/this.timeStep/E,this.maxIterations=this.maxDuration/this.timeStep/E,this.bn=p(_(t.bounce,.5),-1,1),this.pd=p(_(t.duration,628),10*C.timeScale,m*C.timeScale),this.m=p(_(t.mass,1),1,m),this.s=p(_(t.stiffness,100),A,m),this.d=p(_(t.damping,10),A,m),this.v=p(_(t.velocity,0),-m,m),this.w0=0,this.zeta=0,this.wd=0,this.b=0,this.completed=!1,this.solverDuration=0,this.settlingDuration=0,this.parent=null,this.onComplete=t.onComplete||ba,u&&this.calculateSDFromBD(),this.compute(),this.ease=d=>{const h=d*this.settlingDuration,s=this.completed,n=this.pd;return h>=n&&!s&&(this.completed=!0,this.onComplete(this.parent)),h<n&&s&&(this.completed=!1),d===0||d===1?d:this.solve(d*this.solverDuration)}}solve(t){const{zeta:u,w0:d,wd:h,b:s}=this;let n=t;return u<1?n=X(-n*u*d)*(1*ga(h*n)+s*ya(h*n)):u===1?n=(1+s*n)*X(-n*d):n=((1+s)*X((-u*d+h)*n)+(1-s)*X((-u*d-h)*n))/2,1-n}calculateSDFromBD(){const t=C.timeScale===1?this.pd/E:this.pd;this.m=1,this.v=0,this.s=fa(2*B/t,2),this.bn>=0?this.d=(1-this.bn)*4*B/t:this.d=4*B/(t*(1+this.bn)),this.s=j(p(this.s,A,m),3),this.d=j(p(this.d,A,300),3)}calculateBDFromSD(){const t=2*B/z(this.s);this.pd=t*(C.timeScale===1?E:1),this.d/(2*z(this.s))<=1?this.bn=1-this.d*t/(4*B):this.bn=4*B/(this.d*t)-1,this.bn=j(p(this.bn,-1,1),3),this.pd=j(p(this.pd,10*C.timeScale,m*C.timeScale),3)}compute(){const{maxRestSteps:t,maxIterations:u,restThreshold:d,timeStep:h,m:s,d:n,s:f,v:i}=this,y=this.w0=p(z(f/s),A,E),g=this.zeta=n/(2*z(f*s));g<1?(this.wd=y*z(1-g*g),this.b=(g*y+-i)/this.wd):g===1?(this.wd=0,this.b=-i+y):(this.wd=y*z(g*g-1),this.b=(g*y+-i)/this.wd);let R=0,L=0,G=0;for(;L<=t&&G<=u;)_a(1-this.solve(R))<d?L++:L=0,this.solverDuration=R,R+=h,G++;this.settlingDuration=j(this.solverDuration*E,0)*C.timeScale}get bounce(){return this.bn}set bounce(t){this.bn=p(_(t,1),-1,1),this.calculateSDFromBD(),this.compute()}get duration(){return this.pd}set duration(t){this.pd=p(_(t,1),10*C.timeScale,m*C.timeScale),this.calculateSDFromBD(),this.compute()}get stiffness(){return this.s}set stiffness(t){this.s=p(_(t,100),A,m),this.calculateBDFromSD(),this.compute()}get damping(){return this.d}set damping(t){this.d=p(_(t,10),A,m),this.calculateBDFromSD(),this.compute()}get mass(){return this.m}set mass(t){this.m=p(_(t,1),1,m),this.compute()}get velocity(){return this.v}set velocity(t){this.v=p(_(t,0),-m,m),this.compute()}}const wa=b=>new xa(b);var Da=H('<button class="condition-pill"> </button>'),Ca=H('<div class="conditions-row"></div>'),ka=H("<button></button>"),Ta=H('<div class="resource-row"><span class="resource-label"> </span> <div class="resource-pips"></div></div>'),Oa=H('<div class="resources-section"></div> <fieldset class="rest-buttons"><legend class="rest-label">DESCANSOS</legend> <button class="btn-base btn-rest">CORTO</button> <button class="btn-base btn-rest">LARGO</button></fieldset>',1),Aa=H('<article><div class="hit-flash"></div> <div class="char-header"><img class="char-photo" loading="lazy"/> <div class="char-identity"><h2 class="char-name"> </h2> <span class="char-player"> </span></div> <div class="char-header-actions"><div class="char-hp-nums"><span> </span> <span class="hp-sep">/</span> <span class="hp-max"> </span></div> <button class="collapse-toggle" type="button"><span class="collapse-icon" aria-hidden="true">▾</span> <span class="sr-only"> </span></button></div></div>  <div class="hp-track" role="progressbar" aria-label="Puntos de vida"><div></div></div> <div class="char-body"><div class="char-stats"><div class="stat-item"><span class="stat-label">CA</span> <span class="stat-value"> </span></div> <span class="stat-divider">|</span> <div class="stat-item"><span class="stat-label">VEL</span> <span class="stat-value"> </span></div></div> <!> <!> <div class="char-controls"><button class="btn-base btn-damage">− DAÑO</button> <div class="stepper-cluster"><button class="stepper" aria-label="Reducir"><span class="stepper-text">−</span></button> <input class="amount-input" type="number" min="1" max="999" aria-label="Cantidad"/> <button class="stepper" aria-label="Aumentar"><span class="stepper-text">+</span></button></div> <button class="btn-base btn-heal">+ CURAR</button></div></div></article>');function Fa(b,t){zt(t,!0);const u=["/assets/img/barbarian.png","/assets/img/elf.png","/assets/img/wizard.png"];function d(a){if(!a){const c=u[Math.floor(Math.random()*u.length)];return`${O}${c}`}return a.startsWith("http://")||a.startsWith("https://")||a.startsWith("data:")||a.startsWith("blob:")?a:a.startsWith("/")?`${O}${a}`:`${O}/${a.replace(/^\/+/,"")}`}let h=pt(5),s=pt(!1),n=pt(!1),f,i,y=0;ha(()=>{y=t.character.hp_current}),ea(()=>{const a=t.character.hp_current;a<y&&f&&(f.style.opacity="0.5",Y(f,{opacity:0,duration:900,ease:"outCubic"})),y=a});function g(){if(!i){S(s,!e(s)),S(n,e(s),!0);return}if(!e(s)){const c=i.scrollHeight;i.style.height=`${c}px`,i.style.opacity="1",i.style.overflow="hidden",S(s,!0),Y(i,{height:0,duration:700,ease:"inOutCubic"}),Y(i,{opacity:0,duration:450,delay:150,ease:"linear",complete:()=>{i.style.display="none",i.style.height="",i.style.opacity="",i.style.overflow="",S(n,!0)}});return}i.style.display="block";const a=i.scrollHeight;i.style.height="0px",i.style.opacity="0",i.style.overflow="hidden",S(s,!1),Y(i,{height:a,opacity:1,duration:250,ease:wa({bounce:.3,duration:300}),complete:()=>{i.style.height="",i.style.opacity="",i.style.overflow="",S(n,!1)}})}async function R(a){let c=a==="damage"?t.character.hp_current-e(h):t.character.hp_current+e(h);c=Math.max(0,Math.min(c,t.character.hp_max));try{const v=await fetch(`${O}/api/characters/${t.character.id}/hp`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({hp_current:c})});v.ok||(console.error("Failed to update HP",v.status),alert("Failed to update HP. Please try again."))}catch(v){console.error("Error while updating HP",v),alert("An error occurred while updating HP. Please check your connection and try again.")}}async function L(a){const c=await fetch(`${O}/api/characters/${t.character.id}/conditions/${a}`,{method:"DELETE"});c.ok||console.error("Failed to remove condition",c.status)}async function G(a,c){const v=c?a.pool_current-1:a.pool_current+1,k=await fetch(`${O}/api/characters/${t.character.id}/resources/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({pool_current:v})});k.ok||console.error("Failed to update resource",k.status)}async function vt(a){const c=await fetch(`${O}/api/characters/${t.character.id}/rest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:a})});c.ok||console.error("Failed to take rest",c.status)}function Mt(a){const c=a.currentTarget;c.dataset.fallbackApplied!=="true"&&(c.dataset.fallbackApplied="true",c.src=d(""))}const M=Q(()=>t.character.hp_current/t.character.hp_max*100),Vt=Q(()=>e(M)>60?"hp--healthy":e(M)>30?"hp--injured":"hp--critical"),Nt=Q(()=>d(t.character.photo));var V=Aa();let mt;var bt=l(V);Pt(bt,a=>f=a,()=>f);var tt=o(bt,2),N=l(tt),at=o(N,2),et=l(at),Ut=l(et,!0);r(et);var ft=o(et,2),Wt=l(ft,!0);r(ft),r(at);var _t=o(at,2),st=l(_t),K=l(st);let gt;var jt=l(K,!0);r(K);var yt=o(K,4),It=l(yt,!0);r(yt),r(st);var U=o(st,2),St=o(l(U),2),Jt=l(St,!0);r(St),r(U),r(_t),r(tt);var W=o(tt,2),xt=l(W);r(W);var q=o(W,2),it=l(q),rt=l(it),wt=o(l(rt),2),Gt=l(wt,!0);r(wt),r(rt);var Dt=o(rt,4),Ct=o(l(Dt),2),Kt=l(Ct);r(Ct),r(Dt),r(it);var kt=o(it,2);{var qt=a=>{var c=Ca();$(c,21,()=>t.character.conditions,v=>v.id,(v,k)=>{var T=Da(),lt=l(T);r(T),I(()=>w(lt,`${e(k).condition_name??""} ×`)),D("click",T,()=>L(e(k).id)),F(v,T)}),r(c),F(a,c)};Rt(kt,a=>{t.character.conditions&&t.character.conditions.length>0&&a(qt)})}var Tt=o(kt,2);{var Zt=a=>{var c=Oa(),v=sa(c);$(v,21,()=>t.character.resources,ot=>ot.id,(ot,P)=>{var ht=Ta(),dt=l(ht),Yt=l(dt,!0);r(dt);var Et=o(dt,2);$(Et,21,()=>Array(e(P).pool_max),ra,($t,Ha,ta)=>{const ut=Q(()=>ta<e(P).pool_current);var Z=ka();I(aa=>{J(Z,1,`pip pip--${aa??""} ${e(ut)?"pip--filled":"pip--empty"}`),x(Z,"aria-label",`${e(ut)?"Gastar":"Recuperar"} ${e(P).name??""}`)},[()=>e(P).recharge.toLowerCase()]),D("click",Z,()=>G(e(P),e(ut))),F($t,Z)}),r(Et),r(ht),I(()=>w(Yt,e(P).name)),F(ot,ht)}),r(v);var k=o(v,2),T=o(l(k),2),lt=o(T,2);r(k),D("click",T,()=>vt("short")),D("click",lt,()=>vt("long")),F(a,c)};Rt(Tt,a=>{t.character.resources&&t.character.resources.length>0&&a(Zt)})}var Ot=o(Tt,2),At=l(Ot),ct=o(At,2),Ft=l(ct),nt=o(Ft,2);ia(nt);var Qt=o(nt,2);r(ct);var Xt=o(ct,2);r(Ot),r(q),Pt(q,a=>i=a,()=>i),r(V),I(()=>{mt=J(V,1,"char-card card-base",null,mt,{"is-critical":e(M)<=30,collapsed:e(n)}),x(V,"data-char-id",t.character.id),x(N,"src",e(Nt)),x(N,"alt",t.character.name),w(Ut,t.character.name),w(Wt,t.character.player),gt=J(K,1,"hp-cur",null,gt,{critical:e(M)<=30}),w(jt,t.character.hp_current),w(It,t.character.hp_max),x(U,"aria-expanded",!e(s)),x(U,"aria-controls",`char-body-${t.character.id}`),w(Jt,e(s)?"Expandir":"Colapsar"),x(W,"aria-valuenow",t.character.hp_current),x(W,"aria-valuemax",t.character.hp_max),J(xt,1,`hp-fill ${e(Vt)??""}`),Sa(xt,`width: ${e(M)??""}%`),x(q,"id",`char-body-${t.character.id}`),w(Gt,t.character.armor_class),w(Kt,`${t.character.speed_walk??""}ft`)}),ua("error",N,Mt),pa(N),D("click",U,g),D("click",At,()=>R("damage")),D("click",Ft,()=>S(h,Math.max(1,e(h)-1),!0)),va(nt,()=>e(h),a=>S(h,a)),D("click",Qt,()=>S(h,Math.min(999,e(h)+1),!0)),D("click",Xt,()=>R("heal")),F(b,V),Lt()}da(["click"]);var Ea=H("<div></div>");function qa(b,t){zt(t,!1);const u=()=>oa(ma,"$characters",d),[d,h]=la();na();var s=Ea();let n;$(s,5,u,f=>f.id,(f,i)=>{Fa(f,{get character(){return e(i)}})}),r(s),I(()=>n=J(s,1,"characters-grid",null,n,{"grid-three":u().length>2})),F(b,s),Lt(),h()}export{qa as component};

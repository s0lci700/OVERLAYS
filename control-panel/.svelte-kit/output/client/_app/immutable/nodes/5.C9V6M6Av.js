import"../chunks/DsnmJJEf.js";import{o as Gt,p as Qt,d as ue,c as n,s,r as i,t as Q,i as e,L as S,a as Xt,M as Y,N as I,aJ as pe,f as Yt,U as ve}from"../chunks/ab1WaRnl.js";import{d as $t,s as A,e as be,r as me,a as _}from"../chunks/Cxuf-16e.js";import{a as R,f as L}from"../chunks/C0gwv_6f.js";import{r as Et,s as O,c as fe,e as St,i as _e}from"../chunks/hbQhw9FI.js";import{t as ge,s as X}from"../chunks/CRAvAg1A.js";import{b as te}from"../chunks/CV7Gzqws.js";import{s as ye,a as Se}from"../chunks/BddI7m7i.js";import{o as ke}from"../chunks/BbZTPJXo.js";import{i as Ht}from"../chunks/D5oBZPha.js";import{p as Bt,b as qt}from"../chunks/D-KA_8Fk.js";import{S as B,c as xe}from"../chunks/DKBTBH1p.js";import{i as Zt,K as W,c as f,s as C,g as H,m as V,n as we,p as De,P as q,r as pt,b as Z,d as Ce,e as gt,f as Te,h as Oe,a as yt}from"../chunks/CGV0KQgZ.js";function Ae(D,t,h,p){var y=D.__style;if(Gt||y!==t){var u=ge(t);(!Gt||u!==D.getAttribute("style"))&&(u==null?D.removeAttribute("style"):D.style.cssText=u),D.__style=t}return p}const x=W*10;class Me{constructor(t={}){const h=!Zt(t.bounce)||!Zt(t.duration);this.timeStep=.02,this.restThreshold=5e-4,this.restDuration=200,this.maxDuration=6e4,this.maxRestSteps=this.restDuration/this.timeStep/W,this.maxIterations=this.maxDuration/this.timeStep/W,this.bn=f(C(t.bounce,.5),-1,1),this.pd=f(C(t.duration,628),10*H.timeScale,x*H.timeScale),this.m=f(C(t.mass,1),1,x),this.s=f(C(t.stiffness,100),V,x),this.d=f(C(t.damping,10),V,x),this.v=f(C(t.velocity,0),-x,x),this.w0=0,this.zeta=0,this.wd=0,this.b=0,this.completed=!1,this.solverDuration=0,this.settlingDuration=0,this.parent=null,this.onComplete=t.onComplete||we,h&&this.calculateSDFromBD(),this.compute(),this.ease=p=>{const y=p*this.settlingDuration,u=this.completed,l=this.pd;return y>=l&&!u&&(this.completed=!0,this.onComplete(this.parent)),y<l&&u&&(this.completed=!1),p===0||p===1?p:this.solve(p*this.solverDuration)}}solve(t){const{zeta:h,w0:p,wd:y,b:u}=this;let l=t;return h<1?l=gt(-l*h*p)*(1*Te(y*l)+u*Oe(y*l)):h===1?l=(1+u*l)*gt(-l*p):l=((1+u)*gt((-h*p+y)*l)+(1-u)*gt((-h*p-y)*l))/2,1-l}calculateSDFromBD(){const t=H.timeScale===1?this.pd/W:this.pd;this.m=1,this.v=0,this.s=De(2*q/t,2),this.bn>=0?this.d=(1-this.bn)*4*q/t:this.d=4*q/(t*(1+this.bn)),this.s=pt(f(this.s,V,x),3),this.d=pt(f(this.d,V,300),3)}calculateBDFromSD(){const t=2*q/Z(this.s);this.pd=t*(H.timeScale===1?W:1),this.d/(2*Z(this.s))<=1?this.bn=1-this.d*t/(4*q):this.bn=4*q/(this.d*t)-1,this.bn=pt(f(this.bn,-1,1),3),this.pd=pt(f(this.pd,10*H.timeScale,x*H.timeScale),3)}compute(){const{maxRestSteps:t,maxIterations:h,restThreshold:p,timeStep:y,m:u,d:l,s:g,v:d}=this,w=this.w0=f(Z(g/u),V,W),o=this.zeta=l/(2*Z(g*u));o<1?(this.wd=w*Z(1-o*o),this.b=(o*w+-d)/this.wd):o===1?(this.wd=0,this.b=-d+w):(this.wd=w*Z(o*o-1),this.b=(o*w+-d)/this.wd);let c=0,M=0,U=0;for(;M<=t&&U<=h;)Ce(1-this.solve(c))<p?M++:M=0,this.solverDuration=c,c+=y,U++;this.settlingDuration=pt(this.solverDuration*W,0)*H.timeScale}get bounce(){return this.bn}set bounce(t){this.bn=f(C(t,1),-1,1),this.calculateSDFromBD(),this.compute()}get duration(){return this.pd}set duration(t){this.pd=f(C(t,1),10*H.timeScale,x*H.timeScale),this.calculateSDFromBD(),this.compute()}get stiffness(){return this.s}set stiffness(t){this.s=f(C(t,100),V,x),this.calculateBDFromSD(),this.compute()}get damping(){return this.d}set damping(t){this.d=f(C(t,10),V,x),this.calculateBDFromSD(),this.compute()}get mass(){return this.m}set mass(t){this.m=f(C(t,1),1,x),this.compute()}get velocity(){return this.v}set velocity(t){this.v=f(C(t,0),-x,x),this.compute()}}const Pe=D=>new Me(D);var Fe=L('<label class="char-select"><input class="char-select-input" type="checkbox"/> <span class="char-select-box" aria-hidden="true"></span></label>'),He=L('<button class="condition-pill"> </button>'),Be=L('<div class="conditions-row"></div>'),Ee=L("<button></button>"),Ne=L('<div class="resource-row"><span class="resource-label"> </span> <div class="resource-pips"></div></div>'),Re=L('<div class="resources-section"></div> <fieldset class="rest-buttons"><legend class="rest-label">DESCANSOS</legend> <button class="btn-base btn-rest">CORTO</button> <button class="btn-base btn-rest">LARGO</button></fieldset>',1),Le=L('<article><div class="hit-flash"></div> <div class="char-header"><!> <img class="char-photo" loading="lazy"/> <div class="char-identity"><h2 class="char-name"> </h2> <span class="char-player"> </span></div> <div class="char-header-actions"><div class="char-hp-nums"><span> </span> <span class="hp-sep">/</span> <span class="hp-max"> </span></div> <button class="collapse-toggle" type="button"><span class="collapse-icon" aria-hidden="true">▾</span> <span class="sr-only"> </span></button></div></div>  <div class="hp-track" role="progressbar" aria-label="Puntos de vida"><div></div></div> <div class="char-body"><div class="char-stats"><div class="stat-item"><span class="stat-label">CA</span> <span class="stat-value"> </span></div> <span class="stat-divider">|</span> <div class="stat-item"><span class="stat-label">VEL</span> <span class="stat-value"> </span></div></div> <!> <!> <div class="char-controls"><button class="btn-base btn-damage">− DAÑO</button> <div class="stepper-cluster"><button class="stepper" aria-label="Reducir"><span class="stepper-text">−</span></button> <input class="amount-input" type="number" min="1" max="999" aria-label="Cantidad"/> <button class="stepper" aria-label="Aumentar"><span class="stepper-text">+</span></button></div> <button class="btn-base btn-heal">+ CURAR</button></div></div></article>');function Ue(D,t){Qt(t,!0);const h=["/assets/img/barbarian.png","/assets/img/elf.png","/assets/img/wizard.png"];function p(a){if(!a){const r=h[Math.floor(Math.random()*h.length)];return`${B}${r}`}return a.startsWith("http://")||a.startsWith("https://")||a.startsWith("data:")||a.startsWith("blob:")?a:a.startsWith("/")?`${B}${a}`:`${B}/${a.replace(/^\/+/,"")}`}let y=Bt(t,"selectable",3,!1),u=Bt(t,"selected",3,!1),l=Bt(t,"onToggleSelect",3,()=>{}),g=Y(5),d=Y(!1),w=Y(!1),o,c,M=0;ke(()=>{M=t.character.hp_current}),ue(()=>{const a=t.character.hp_current;a<M&&o&&(o.style.opacity="0.5",yt(o,{opacity:0,duration:900,ease:"outCubic"})),M=a});function U(){if(!c){S(d,!e(d)),S(w,e(d),!0);return}if(!e(d)){const r=c.scrollHeight;c.style.height=`${r}px`,c.style.opacity="1",c.style.overflow="hidden",S(d,!0),yt(c,{height:0,duration:700,ease:"inOutCubic"}),yt(c,{opacity:0,duration:450,delay:150,ease:"linear",complete:()=>{c.style.display="none",c.style.height="",c.style.opacity="",c.style.overflow="",S(w,!0)}});return}c.style.display="block";const a=c.scrollHeight;c.style.height="0px",c.style.opacity="0",c.style.overflow="hidden",S(d,!1),yt(c,{height:a,opacity:1,duration:250,ease:Pe({bounce:.3,duration:300}),complete:()=>{c.style.height="",c.style.opacity="",c.style.overflow="",S(w,!1)}})}async function vt(a){let r=a==="damage"?t.character.hp_current-e(g):t.character.hp_current+e(g);r=Math.max(0,Math.min(r,t.character.hp_max));try{const b=await fetch(`${B}/api/characters/${t.character.id}/hp`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({hp_current:r})});b.ok||(console.error("Failed to update HP",b.status),alert("Failed to update HP. Please try again."))}catch(b){console.error("Error while updating HP",b),alert("An error occurred while updating HP. Please check your connection and try again.")}}async function bt(a){const r=await fetch(`${B}/api/characters/${t.character.id}/conditions/${a}`,{method:"DELETE"});r.ok||console.error("Failed to remove condition",r.status)}async function mt(a,r){const b=r?a.pool_current-1:a.pool_current+1,N=await fetch(`${B}/api/characters/${t.character.id}/resources/${a.id}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({pool_current:b})});N.ok||console.error("Failed to update resource",N.status)}async function $(a){const r=await fetch(`${B}/api/characters/${t.character.id}/rest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:a})});r.ok||console.error("Failed to take rest",r.status)}function tt(a){const r=a.currentTarget;r.dataset.fallbackApplied!=="true"&&(r.dataset.fallbackApplied="true",r.src=p(""))}const P=I(()=>t.character.hp_current/t.character.hp_max*100),kt=I(()=>e(P)>60?"hp--healthy":e(P)>30?"hp--injured":"hp--critical"),et=I(()=>p(t.character.photo));var F=Le();let at;var st=n(F);qt(st,a=>o=a,()=>o);var K=s(st,2),it=n(K);{var rt=a=>{var r=Fe(),b=n(r);Et(b),pe(2),i(r),Q(()=>{fe(b,u()),O(b,"aria-label",`Seleccionar ${t.character.name}`)}),_("change",b,()=>l()(t.character.id)),R(a,r)};Ht(it,a=>{y()&&a(rt)})}var E=s(it,2),z=s(E,2),j=n(z),nt=n(j,!0);i(j);var ct=s(j,2),lt=n(ct,!0);i(ct),i(z);var ot=s(z,2),v=n(ot),m=n(v);let k;var xt=n(m,!0);i(m);var T=s(m,4),dt=n(T,!0);i(T),i(v);var ht=s(v,2),Nt=s(n(ht),2),ee=n(Nt,!0);i(Nt),i(ht),i(ot),i(K);var ut=s(K,2),Rt=n(ut);i(ut);var ft=s(ut,2),wt=n(ft),Dt=n(wt),Lt=s(n(Dt),2),ae=n(Lt,!0);i(Lt),i(Dt);var Ut=s(Dt,4),zt=s(n(Ut),2),se=n(zt);i(zt),i(Ut),i(wt);var jt=s(wt,2);{var ie=a=>{var r=Be();St(r,21,()=>t.character.conditions,b=>b.id,(b,N)=>{var J=He(),Ot=n(J);i(J),Q(()=>A(Ot,`${e(N).condition_name??""} ×`)),_("click",J,()=>bt(e(N).id)),R(b,J)}),i(r),R(a,r)};Ht(jt,a=>{t.character.conditions&&t.character.conditions.length>0&&a(ie)})}var Jt=s(jt,2);{var re=a=>{var r=Re(),b=Yt(r);St(b,21,()=>t.character.resources,At=>At.id,(At,G)=>{var Mt=Ne(),Pt=n(Mt),le=n(Pt,!0);i(Pt);var Kt=s(Pt,2);St(Kt,21,()=>Array(e(G).pool_max),_e,(oe,je,de)=>{const Ft=I(()=>de<e(G).pool_current);var _t=Ee();Q(he=>{X(_t,1,`pip pip--${he??""} ${e(Ft)?"pip--filled":"pip--empty"}`),O(_t,"aria-label",`${e(Ft)?"Gastar":"Recuperar"} ${e(G).name??""}`)},[()=>e(G).recharge.toLowerCase()]),_("click",_t,()=>mt(e(G),e(Ft))),R(oe,_t)}),i(Kt),i(Mt),Q(()=>A(le,e(G).name)),R(At,Mt)}),i(b);var N=s(b,2),J=s(n(N),2),Ot=s(J,2);i(N),_("click",J,()=>$("short")),_("click",Ot,()=>$("long")),R(a,r)};Ht(Jt,a=>{t.character.resources&&t.character.resources.length>0&&a(re)})}var Vt=s(Jt,2),Wt=n(Vt),Ct=s(Wt,2),It=n(Ct),Tt=s(It,2);Et(Tt);var ne=s(Tt,2);i(Ct);var ce=s(Ct,2);i(Vt),i(ft),qt(ft,a=>c=a,()=>c),i(F),Q(()=>{at=X(F,1,"char-card card-base",null,at,{"is-critical":e(P)<=30,collapsed:e(w),"is-selected":u()}),O(F,"data-char-id",t.character.id),O(E,"src",e(et)),O(E,"alt",t.character.name),A(nt,t.character.name),A(lt,t.character.player),k=X(m,1,"hp-cur",null,k,{critical:e(P)<=30}),A(xt,t.character.hp_current),A(dt,t.character.hp_max),O(ht,"aria-expanded",!e(d)),O(ht,"aria-controls",`char-body-${t.character.id}`),A(ee,e(d)?"Expandir":"Colapsar"),O(ut,"aria-valuenow",t.character.hp_current),O(ut,"aria-valuemax",t.character.hp_max),X(Rt,1,`hp-fill ${e(kt)??""}`),Ae(Rt,`width: ${e(P)??""}%`),O(ft,"id",`char-body-${t.character.id}`),A(ae,t.character.armor_class),A(se,`${t.character.speed_walk??""}ft`)}),be("error",E,tt),me(E),_("click",ht,U),_("click",Wt,()=>vt("damage")),_("click",It,()=>S(g,Math.max(1,e(g)-1),!0)),te(Tt,()=>e(g),a=>S(g,a)),_("click",ne,()=>S(g,Math.min(999,e(g)+1),!0)),_("click",ce,()=>vt("heal")),R(D,F),Xt()}$t(["change","click"]);var ze=L('<section class="bulk-controls"><span class="bulk-controls-title">Seleccion multiple</span> <span class="bulk-controls-count"> </span> <div class="bulk-controls-actions"><button type="button">Modo multi</button> <button class="bulk-toggle" type="button">Seleccionar todos</button> <button class="bulk-toggle" type="button">Limpiar</button></div> <div class="bulk-controls-actions"><div class="bulk-amount"><span class="bulk-controls-title">Cantidad</span> <input type="number" min="1" max="999" aria-label="Cantidad de HP"/></div> <button class="btn-base bulk-action damage" type="button">− Dano</button> <button class="btn-base bulk-action heal" type="button">+ Curar</button> <button class="btn-base bulk-action rest" type="button">Descanso corto</button> <button class="btn-base bulk-action rest" type="button">Descanso largo</button></div></section> <div></div>',1);function ea(D,t){Qt(t,!0);const h=()=>Se(xe,"$characters",p),[p,y]=ye(),u=5;let l=Y(ve(new Set)),g=Y(u),d=Y(!1),w=I(()=>e(l).size),o=I(()=>e(d)&&e(w)>0);function c(){S(d,!e(d)),e(d)||U()}function M(v){const m=new Set(e(l));m.has(v)?m.delete(v):m.add(v),S(l,m,!0)}function U(){S(l,new Set,!0)}function vt(){e(d)&&S(l,new Set(h().map(v=>v.id)),!0)}async function bt(v){if(!e(o))return;const m=Number(e(g)),k=Math.max(1,Math.min(999,Number.isFinite(m)?Math.trunc(m):u));S(g,k,!0);const xt=h().filter(T=>e(l).has(T.id));try{await Promise.all(xt.map(T=>{let dt=v==="damage"?T.hp_current-k:T.hp_current+k;return dt=Math.max(0,Math.min(dt,T.hp_max)),fetch(`${B}/api/characters/${T.id}/hp`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({hp_current:dt})})}))}catch(T){console.error("Bulk HP update failed",T),alert("No se pudo actualizar a todos. Intenta nuevamente.")}}async function mt(v){if(!e(o))return;const m=h().filter(k=>e(l).has(k.id));try{await Promise.all(m.map(k=>fetch(`${B}/api/characters/${k.id}/rest`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({type:v})})))}catch(k){console.error("Bulk rest failed",k),alert("No se pudo aplicar el descanso a todos.")}}var $=ze(),tt=Yt($),P=s(n(tt),2),kt=n(P);i(P);var et=s(P,2),F=n(et);let at;var st=s(F,2),K=s(st,2);i(et);var it=s(et,2),rt=n(it),E=s(n(rt),2);Et(E),i(rt);var z=s(rt,2),j=s(z,2),nt=s(j,2),ct=s(nt,2);i(it),i(tt);var lt=s(tt,2);let ot;St(lt,5,h,v=>v.id,(v,m)=>{{let k=I(()=>e(d)&&e(l).has(e(m).id));Ue(v,{get character(){return e(m)},get selectable(){return e(d)},get selected(){return e(k)},onToggleSelect:M})}}),i(lt),Q(()=>{A(kt,`${e(w)??""} elegidos`),at=X(F,1,"bulk-toggle",null,at,{"is-active":e(d)}),K.disabled=!e(o),z.disabled=!e(o),j.disabled=!e(o),nt.disabled=!e(o),ct.disabled=!e(o),ot=X(lt,1,"characters-grid",null,ot,{"grid-three":h().length>2})}),_("click",F,c),_("click",st,vt),_("click",K,U),te(E,()=>e(g),v=>S(g,v)),_("click",z,()=>bt("damage")),_("click",j,()=>bt("heal")),_("click",nt,()=>mt("short")),_("click",ct,()=>mt("long")),R(D,$),Xt(),y()}$t(["click"]);export{ea as component};

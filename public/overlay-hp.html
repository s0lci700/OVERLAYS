<!doctype html>
<!--
  DADOS & RISAS - HP Overlay
  ==========================
  OBS Browser Source overlay for displaying character HP bars in real-time.
  
  Setup:
  - Add as Browser Source in OBS (1920×1080)
  - Enable "Shutdown source when not visible" = OFF
  - Enable "Refresh browser when scene becomes active" = ON
  - Canvas body background must be transparent in OBS settings
  
  Behavior:
  - Receives initial character data on 'initialData' event
  - Listens for 'hp_updated' events to animate HP changes
  - Color-codes HP bars: green (>60%), orange (30-60%), red (<30%)
  - Critical HP (<30%) shows pulsing animation
  - Displays brief status messages on connection/HP changes
  
  Dependencies:
  - anime.js 3.2.1 (animation engine, currently unused but available)
  - Socket.io 4.8.3 (real-time client)
  - overlay-hp.css (external stylesheet)
-->
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=1920, height=1080" />
    <title>DADOS & RISAS - HP Overlay</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="overlay-hp.css" />
  </head>
  <body>
    <!-- Status message banner (connection state, HP updates) -->
    <div id="status" class="status-message">Conectando...</div>

    <!-- Character HP cards are dynamically rendered here via JavaScript -->
    <div id="hp-container"></div>

    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.socket.io/4.8.3/socket.io.min.js"></script>

    <script>
      // ═══════════════════════════════════════════════════════════════════════
      // HP Overlay Logic
      // ═══════════════════════════════════════════════════════════════════════

      /**
       * Socket.io connection to the server.
       * Configure the server URL via the `server` query parameter, e.g.:
       *   overlay-hp.html?server=http://192.168.1.83:3000
       * Falls back to http://localhost:3000 when no parameter is provided.
       */
      const serverUrl = new URLSearchParams(window.location.search).get("server") || "http://localhost:3000";
      const socket = io(serverUrl);

      // ───────────────────────────────────────────────────────────────────────
      // DOM Element References
      // ───────────────────────────────────────────────────────────────────────

      /** Container where character HP cards are rendered */
      const hpContainer = document.getElementById("hp-container");

      /** Status banner element for connection/update messages */
      const statusMessage = document.getElementById("status");

      // ───────────────────────────────────────────────────────────────────────
      // Utility Functions
      // ───────────────────────────────────────────────────────────────────────

      /**
       * Displays a temporary status message banner at the top of the overlay.
       * Message auto-hides after 2 seconds via CSS animation.
       *
       * @param {string} message - Text to display
       */
      function showStatus(message) {
        statusMessage.textContent = message;
        statusMessage.classList.add("show");
        setTimeout(() => statusMessage.classList.remove("show"), 2000);
      }

      /**
       * Calculates HP as a percentage of max.
       *
       * @param {number} current - Current HP
       * @param {number} max - Maximum HP
       * @returns {number} Percentage (0-100)
       */
      function getHPPercentage(current, max) {
        return (current / max) * 100;
      }

      /**
       * Determines HP bar color class based on health threshold.
       *
       * Thresholds:
       * - healthy: >60% HP (green gradient)
       * - injured: 30-60% HP (orange gradient)
       * - critical: <30% HP (red gradient + pulse animation)
       *
       * @param {number} percentage - HP percentage (0-100)
       * @returns {string} CSS class name
       */
      function getHPClass(percentage) {
        if (percentage > 60) return "healthy";
        if (percentage > 30) return "injured";
        return "critical";
      }

      // ───────────────────────────────────────────────────────────────────────
      // Rendering Functions
      // ───────────────────────────────────────────────────────────────────────

      /**
       * Generates HTML for a single character HP card.
       * Card includes character name, player name, HP bar, and HP text.
       *
       * The `data-char-id` attribute is used for targeted DOM updates
       * when HP changes (see updateCharacterHP).
       *
       * @param {Object} character - Character data object
       * @param {string} character.id - Unique character ID
       * @param {string} character.name - Character name
       * @param {string} character.player - Player name
       * @param {number} character.hp_current - Current HP
       * @param {number} character.hp_max - Maximum HP
       * @returns {string} HTML markup for the character card
       */
      function createCharacterHP(character) {
        const percentage = getHPPercentage(
          character.hp_current,
          character.hp_max,
        );
        const hpClass = getHPClass(percentage);

        return `
                <div class="character-hp" data-char-id="${character.id}">
                    <div class="char-name">${character.name}</div>
                    <div class="char-player">${character.player}</div>
                    <div class="hp-bar-container">
                        <div class="hp-bar-fill ${hpClass}" style="width: ${percentage}%"></div>
                    </div>
                    <div class="hp-text">${character.hp_current} / ${character.hp_max}</div>
                </div>
            `;
      }

      /**
       * Updates an existing character HP card in the DOM.
       * Only mutates the HP bar fill and text, preserving the rest of the card.
       * This is more efficient than re-rendering the entire card on each update.
       *
       * The HP bar width transition is handled by CSS (0.5s cubic-bezier).
       *
       * @param {Object} character - Updated character data
       * @param {string} character.id - Character ID to target
       * @param {number} character.hp_current - New current HP
       * @param {number} character.hp_max - Maximum HP
       */
      function updateCharacterHP(character) {
        const charElement = document.querySelector(
          `[data-char-id="${character.id}"]`,
        );
        if (!charElement) return;

        const percentage = getHPPercentage(
          character.hp_current,
          character.hp_max,
        );
        const hpClass = getHPClass(percentage);

        const hpBarFill = charElement.querySelector(".hp-bar-fill");
        const hpText = charElement.querySelector(".hp-text");

        // Update HP bar color class based on new percentage
        hpBarFill.classList.remove("healthy", "injured", "critical");
        hpBarFill.classList.add(hpClass);

        // Update bar width (CSS transition handles animation)
        hpBarFill.style.width = percentage + "%";

        // Update HP text display
        hpText.textContent = `${character.hp_current} / ${character.hp_max}`;
      }

      /**
       * Renders all character HP cards on initial load.
       * Called once when 'initialData' event fires from server.
       *
       * @param {Array} characters - Array of character objects
       */
      function renderAllCharacters(characters) {
        hpContainer.innerHTML = characters.map(createCharacterHP).join("");
      }

      // ───────────────────────────────────────────────────────────────────────
      // Socket.io Event Handlers
      // ───────────────────────────────────────────────────────────────────────

      /**
       * Fires when Socket.io successfully connects to the server.
       * Shows a brief success status message.
       */
      socket.on("connect", () => {
        console.log("Connected to server");
        showStatus("✓ Conectado");
      });

      /**
       * Fires when Socket.io disconnects from the server.
       * Shows a warning status message.
       */
      socket.on("disconnect", () => {
        console.log("Disconnected from server");
        showStatus("✗ Desconectado");
      });

      /**
       * Receives initial character data on connection.
       * Renders all character HP cards in the container.
       *
       * Event payload structure:
       * {
       *   characters: [
       *     {
       *       id: string,
       *       name: string,
       *       player: string,
       *       hp_current: number,
       *       hp_max: number,
       *       armor_class: number,
       *       speed_walk: number,
       *       ...
       *     },
       *     ...
       *   ],
       *   rolls: [...]
       * }
       */
      socket.on("initialData", (data) => {
        console.log("Initial data received:", data);
        renderAllCharacters(data.characters);
      });

      /**
       * Handles HP update events from the server.
       * Triggered when any client updates a character's HP.
       * Updates only the affected character's card (efficient DOM mutation).
       *
       * Event payload structure:
       * {
       *   character: { id, name, hp_current, hp_max, ... },
       *   hp_current: number  // Duplicate for convenience
       * }
       */
      socket.on("hp_updated", (data) => {
        console.log("HP updated:", data);
        updateCharacterHP(data.character);
        showStatus(`${data.character.name}: ${data.hp_current} HP`);
      });

      /**
       * Fires when Socket.io connection fails or encounters an error.
       * Shows an error status message.
       */
      socket.on("connect_error", (error) => {
        console.error("Connection error:", error);
        showStatus("✗ Error de conexión");
      });
    </script>
  </body>
</html>
